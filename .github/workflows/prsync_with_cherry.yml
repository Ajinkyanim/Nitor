name: Cherry-pick - Step 1 (manual input only)

on:
  workflow_dispatch:
    inputs:
      commits:
        description: "Comma-separated commit hashes to cherry-pick"
        required: false
        default: ""

env:
  SOURCE_BRANCH: "destination"
  TARGET_BRANCH: "main"
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  prepare:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Print environment variables
        run: |
          echo "SOURCE_BRANCH = $SOURCE_BRANCH"
          echo "TARGET_BRANCH = $TARGET_BRANCH"
      
      - name: Print received commits input
        run: |
          echo "Commits input: '${{ github.event.inputs.commits }}'"
      
      - name: Format commits (trim spaces, split by comma)
        id: format_commits
        run: |
          INPUT="${{ github.event.inputs.commits }}"
          if [ -z "$INPUT" ]; then
            echo "No commits provided."
            echo '[]' > commits.json
          else
            echo "$INPUT" | tr ',' '\n' | sed 's/^[ \t]*//;s/[ \t]*$//' | sed '/^$/d' > cleaned.txt
            jq -R . cleaned.txt | jq -s . > commits.json
          fi
      
           echo "Pretty printed commits JSON:"
           cat commits.json | jq .
           
          # Export compact JSON for GitHub Actions output
           COMPACT=$(jq -c . commits.json)
           echo "commits_json=$COMPACT" >> $GITHUB_OUTPUT
      
          # Print compact one-line JSON also (optional)
          echo "Compact JSON: $COMPACT"

      - name: Validate commits
        id: validate_commits
        run: |
          git fetch origin $SOURCE_BRANCH
          git checkout $SOURCE_BRANCH

          COMMITS=$(echo '${{ steps.format_commits.outputs.commits_json }}' | jq -r '.[]')
          INVALID=()

          for c in $COMMITS; do
            if git cat-file -e "$c" 2>/dev/null; then
              echo "OK: $c"
            else
              INVALID+=("$c")
            fi
          done

          if [ ${#INVALID[@]} -ne 0 ]; then
            echo "Invalid commits: ${INVALID[*]}"
            exit 1
          fi
          
      - name: Prepare reusable branch
        id: prepare_branch
        run: |
          REUSE_BRANCH="cp-${SOURCE_BRANCH}-to-${TARGET_BRANCH}"
          echo "reuse_branch=$REUSE_BRANCH" >> $GITHUB_OUTPUT
      
          git fetch origin
      
          if git ls-remote --exit-code --heads origin "$REUSE_BRANCH" >/dev/null; then
            echo "Branch exists. Reusing: $REUSE_BRANCH"
            git checkout "$REUSE_BRANCH"
            git reset --hard origin/$TARGET_BRANCH
          else
            echo "Branch does not exist. Creating: $REUSE_BRANCH"
            git checkout -b "$REUSE_BRANCH" origin/$TARGET_BRANCH   # <-- FIXED
            git push -u origin "$REUSE_BRANCH"
          fi
          
      - name: Check if PR already exists
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BR="${{ steps.prepare_branch.outputs.reuse_branch }}"

          PR=$(gh pr list \
              --head "$BR" \
              --state open \
              --json number,title,body \
              --jq '.[0]' || true)

          if [[ -n "$PR" && "$PR" != "null" ]]; then
            echo "PR already exists:"
            echo "$PR"
            exit 1
          fi
