name: Multi Service Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select deployment environment"
        required: true
        type: choice
        options:
          - dev
          - dev02
          - qa
          - qa02
          - uat
          - prod
          - latam-helix
          - latam-uat
          - latam-prod
          
      db_services:
        description: "DB Services (di_db:5.0.123,fund_db:5.0.123)"
        required: false
        type: string

      api_services:
        description: "API Services (scoping:5.0.123,dataimport:5.0.789)"
        required: false
        type: string

      web_services:
        description: "WEB Services (ui:5.0.123,add_in:5.0.789)"
        required: false
        type: string

jobs:
  validate-inputs:
    runs-on: ubuntu-latest
    outputs:
      db_matrix: ${{ steps.create_matrices.outputs.db_matrix }}
      api_matrix: ${{ steps.create_matrices.outputs.api_matrix }}
      web_matrix: ${{ steps.create_matrices.outputs.web_matrix }}
      
    steps:
     # It ensures that at least one service category (DB Services, API Services, or WEB Services) should provide
      - name: Validate at least one service input provided
        run: |
          DB="${{ github.event.inputs.db_services }}"
          API="${{ github.event.inputs.api_services }}"
          WEB="${{ github.event.inputs.web_services }}"

          if [[ -z "$DB" && -z "$API" && -z "$WEB" ]]; then
            echo " ERROR: You must provide at least one service input."
            echo "Provide DB OR API OR WEB services."
            exit 1
          fi

          echo "Input validation passed"
    # It ensures that at format of input should be proper [serviceName:Version.pr] 
      - name: Validate service input formats
        run: |
          validate_input() {
            SERVICES_INPUT="$1"
            INPUT_NAME="$2"

            if [[ -z "$SERVICES_INPUT" ]]; then
              echo "No $INPUT_NAME provided. Skipping validation."
              return
            fi

            echo "Validating $INPUT_NAME..."

            IFS=',' read -ra SERVICES <<< "$SERVICES_INPUT"
            for SERVICE in "${SERVICES[@]}"; do
                  # Remove extra spaces
              SERVICE=$(echo "$SERVICE" | xargs)

                  # Validate format service:X.Y.Z
              if [[ ! "$SERVICE" =~ ^[a-zA-Z0-9_-]+:[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                echo "❌ Invalid format in $INPUT_NAME -> $SERVICE"
                echo "Expected format: service_name:X.Y.Z (example: fund_db:5.0.567)"
                exit 1
              fi
            done
            echo "✅ $INPUT_NAME format validation passed"
          }
               # calling above function for 3 kinds of input format service:X.Y.Z
          validate_input "${{ github.event.inputs.db_services }}" "DB Services"
          validate_input "${{ github.event.inputs.api_services }}" "API Services"
          validate_input "${{ github.event.inputs.web_services }}" "WEB Services"

      # It creates 3 matrix for with proper spaces and validated input [export matrix]
      - name: Create service matrices
        id: create_matrices
        run: |
          create_matrix () {
            INPUT_VALUE="$1"

            # Return empty matrix if no input provided
            if [[ -z "$INPUT_VALUE" ]]; then
              echo "[]"
              return
            fi

            MATRIX_ITEMS=""

            IFS=',' read -ra SERVICES <<< "$INPUT_VALUE"
            
            for SERVICE in "${SERVICES[@]}"; do
                  # Remove leading/trailing spaces
              SERVICE=$(echo "$SERVICE" | xargs)
                  # Split service and version
              NAME=$(echo "$SERVICE" | cut -d':' -f1)
              VERSION=$(echo "$SERVICE" | cut -d':' -f2)
                  # Convert service name to lowercase
              NAME=$(echo "$NAME" | tr '[:upper:]' '[:lower:]')
              CLEAN_VALUE="${NAME}:${VERSION}"
              MATRIX_ITEMS+="\"$CLEAN_VALUE\","
            done

              # Remove trailing comma
            MATRIX_ITEMS=${MATRIX_ITEMS%,}
            echo "[$MATRIX_ITEMS]"
          }

          DB_MATRIX=$(create_matrix "${{ github.event.inputs.db_services }}")
          API_MATRIX=$(create_matrix "${{ github.event.inputs.api_services }}")
          WEB_MATRIX=$(create_matrix "${{ github.event.inputs.web_services }}")

          echo "DB Matrix: $DB_MATRIX"
          echo "API Matrix: $API_MATRIX"
          echo "WEB Matrix: $WEB_MATRIX"

              # Export outputs
          echo "db_matrix=$DB_MATRIX" >> $GITHUB_OUTPUT
          echo "api_matrix=$API_MATRIX" >> $GITHUB_OUTPUT
          echo "web_matrix=$WEB_MATRIX" >> $GITHUB_OUTPUT

  api_deployment:
    name: Trigger API Deployments
    needs: validate-inputs
    runs-on: ubuntu-latest

    # Run only if API matrix has values
    if: ${{ needs.validate-inputs.outputs.api_matrix != '[]' }}

    steps:
      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Trigger API deployment workflows
        env:
          ENVIRONMENT: ${{ github.event.inputs.environment }}
        run: |

          echo "Reading API matrix..."
          SERVICES='${{ needs.validate-inputs.outputs.api_matrix }}'

          echo "Matrix: $SERVICES"

          # Convert JSON array → iterable list
          SERVICES=$(echo "$SERVICES" | jq -r '.[]')

          for SERVICE in $SERVICES; do

            # Example input: scoping:5.0.123
            SERVICE_NAME=$(echo "$SERVICE" | cut -d':' -f1)
            FULL_VERSION=$(echo "$SERVICE" | cut -d':' -f2)

            # Split version into required parameters
            VERSION=$(echo "$FULL_VERSION" | cut -d'.' -f1,2)
            PR_NUMBER=$(echo "$FULL_VERSION" | cut -d'.' -f3)

            echo "--------------------------------"
            echo "Triggering API Deployment"
            echo "Service Name : $SERVICE_NAME"
            echo "Version      : $VERSION"
            echo "PR Number    : $PR_NUMBER"
            echo "Environment  : $ENVIRONMENT"

            gh workflow run AKS-Analysis-CD.yml \
              --ref main \
              -f environment="$ENVIRONMENT" \
              -f service_name="$SERVICE_NAME" \
              -f version="$VERSION" \
              -f pr_number="$PR_NUMBER"

            echo "Workflow triggered for $SERVICE_NAME"

            # Prevent API throttling
            sleep 3
          done
    
